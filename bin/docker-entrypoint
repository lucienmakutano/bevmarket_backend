#!/bin/bash -e

# Set default SECRET_KEY_BASE if not provided
if [ -z "$SECRET_KEY_BASE" ]; then
  echo "Warning: SECRET_KEY_BASE not set, generating a temporary one for startup. Set SECRET_KEY_BASE in production environment."
  export SECRET_KEY_BASE=$(openssl rand -hex 32)
fi

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # Try db:prepare, but on Azure it may fail due to extension restrictions
  # In that case, just run migrations which should work
  ./bin/rails db:prepare || ./bin/rails db:migrate || true
fi

exec "${@}"
